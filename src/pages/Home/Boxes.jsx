import { useSound } from "../../context/ApiProvider";
import { cn } from "../../utils/cn";
import {
  playGem1Sound,
  playGem2Sound,
  playGem3Sound,
  playMineSound,
} from "../../utils/sound";
import WinModal from "./WinModal";

const Boxes = ({
  isStartGame,
  setIsStartGame,
  setBoxData,
  boxData,
  showWinModal,
  betAmount,
  activeBoxCount,
  addOrder,
  selectedBoxes,
  setSelectedBoxes,
  setCurrentMultiplier,
  current_multiplier,
  winMultiplier,
  setLoadingBoxId,
  loadingBoxId,
  // setNextMultiplier,
}) => {
  const { sound } = useSound();

  const handleBoxClick = async (box) => {
    if (isStartGame) {
      if (sound) {
        // playTileClickSound();
      }
      setLoadingBoxId(box.id);

      setTimeout(async () => {
        const round_id = sessionStorage.getItem("round_id");
        const payload = [
          {
            round_id: Number(round_id),
            type: "select_box",
            box_id: box?.id,
            box_count: activeBoxCount,
            eventId: 20002,
            selected_tiles: [...selectedBoxes, box?.id],
          },
        ];
        const res = await addOrder(payload).unwrap();

        if (res.success) {
          setSelectedBoxes((prev) => [...prev, box?.id]);
          // setLoadingBoxId(null);
          if (res?.gem === 0) {
            if (sound) {
              playMineSound();
            }
            const updatedBoxes = boxData?.map((boxObj, i) => ({
              ...boxObj,
              roundEnd: true,
              mine: res?.all?.[i] === 0 ? true : false,
              isOpacityFull:
                res.gem === 0 && box.id === boxObj.id
                  ? true
                  : boxObj?.isOpacityFull,
              win: res?.all?.[i] === 0 ? false : true,
            }));
            setBoxData(updatedBoxes);
            setIsStartGame(false);
          } else {
            const multiplier = Number(res?.current_multiplier) * betAmount;
            setCurrentMultiplier(multiplier.toFixed(2));
            // setNextMultiplier(res?.next_multiplier);
            if (sound) {
              if (box?.id > 0 && box?.id < 6) {
                playGem1Sound();
              } else if (box?.id > 5 && box?.id < 11) {
                playGem2Sound();
              } else {
                playGem3Sound();
              }
            }
            const updatedBoxes = boxData?.map((boxObj) =>
              box?.id === boxObj.id
                ? {
                    ...boxObj,
                    win: true,
                    isOpacityFull: true,
                  }
                : boxObj
            );
            setBoxData(updatedBoxes);
          }
        }
      }, 1000);
    }
  };
  return (
    <div
      className="game-content stake-original svelte-1j8whi0 stacked"
      style={{ minHeight: "280px" }}
    >
      <div
        className="wrap svelte-mm6hdp"
        style={{ fontSize: "0.5em" }}
        data-testid="game-mines"
      >
        {boxData?.map((box) => {
          return (
            <>
              <button
                onClick={() => handleBoxClick(box)}
                key={box?.id}
                style={{
                  "-tileShadowInset": "-0.15em",
                  "-shadow": "0.3em",
                  "-tileShadowLg": "0.44999999999999996em",
                  "-smallShadow": "-0.15em",
                  "-duration": "300ms",
                  "-fetchDuration": "600ms",
                }}
                className={cn(
                  "tile  svelte-vvbnu4",
                  box?.win && "gem",
                  box?.mine && "mine",
                  !box?.mine && !box?.win && "idle",
                  box?.isOpacityFull ? "opacity-100 " : "opacity-25",
                  box?.id === loadingBoxId && "fetching"
                )}
                data-testid="mines-tile"
                data-revealed="false"
              >
                {box?.mine && box?.isOpacityFull && (
                  <img
                    alt="mine effect"
                    className="effect svelte-1r1yj8l"
                    src="/src/assets/mineEffect.webp"
                  ></img>
                )}
                {box?.mine && (
                  <div
                    className="mine svelte-1r1yj8l revealed"
                    style={{
                      backgroundImage: 'url("/src/assets/mine.BrdEJX0T.svg")',
                      backgroundSize: "70%",
                      "-duration:": "300ms",
                    }}
                  />
                )}
                {box?.win && (
                  <div
                    className="gem svelte-1hmx1on revealed"
                    style={{
                      "-mine":
                        "url(/_app/immutable/assets/gem-none.Bcv6X_BH.svg)",
                      "-duration": "300ms",
                    }}
                  >
                    <div className="motion svelte-1hmx1on">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        xmlnsXlink="http://www.w3.org/1999/xlink"
                        viewBox="0 0 308 280"
                        width={308}
                        height={280}
                        preserveAspectRatio="xMidYMid meet"
                        style={{
                          width: "100%",
                          height: "100%",
                          transform: "translate3d(0px, 0px, 0px)",
                          contentVisibility: "visible",
                        }}
                      >
                        <defs>
                          <clipPath id="__lottie_element_48">
                            <rect width={308} height={280} x={0} y={0} />
                          </clipPath>
                        </defs>
                        <g clipPath="url(#__lottie_element_48)">
                          <g
                            transform="matrix(4,0,0,4,0.579010009765625,0)"
                            opacity={1}
                            style={{ display: "block" }}
                          >
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,38.30699920654297,35)"
                            >
                              <path
                                fill="rgb(5,29,39)"
                                fillOpacity={1}
                                d=" M-0.2809999883174896,35 C-0.2809999883174896,35 -0.29600000381469727,35 -0.29600000381469727,35 C-1.0740000009536743,34.99599838256836 -1.815000057220459,34.6619987487793 -2.3340001106262207,34.082000732421875 C-2.3340001106262207,34.082000732421875 -37.606998443603516,-5.380000114440918 -37.606998443603516,-5.380000114440918 C-38.409000396728516,-6.2769999504089355 -38.53499984741211,-7.591000080108643 -37.91899871826172,-8.625 C-37.91899871826172,-8.625 -27.281999588012695,-26.45400047302246 -27.281999588012695,-26.45400047302246 C-26.988000869750977,-26.94700050354004 -26.547000885009766,-27.336000442504883 -26.020000457763672,-27.56599998474121 C-26.020000457763672,-27.56599998474121 -15.1899995803833,-32.29399871826172 -15.1899995803833,-32.29399871826172 C-14.991000175476074,-32.38100051879883 -14.781999588012695,-32.444000244140625 -14.567999839782715,-32.481998443603516 C-14.567999839782715,-32.481998443603516 -0.5709999799728394,-34.95800018310547 -0.5709999799728394,-34.95800018310547 C-0.2529999911785126,-35.013999938964844 0.0729999989271164,-35.013999938964844 0.38999998569488525,-34.95800018310547 C0.38999998569488525,-34.95800018310547 14.312999725341797,-32.481998443603516 14.312999725341797,-32.481998443603516 C14.526000022888184,-32.444000244140625 14.732999801635742,-32.38100051879883 14.930000305175781,-32.29499816894531 C14.930000305175781,-32.29499816894531 26.114999771118164,-27.423999786376953 26.114999771118164,-27.423999786376953 C26.1560001373291,-27.4060001373291 26.197999954223633,-27.386999130249023 26.23900032043457,-27.367000579833984 C26.23900032043457,-27.367000579833984 26.242000579833984,-27.364999771118164 26.242000579833984,-27.364999771118164 C26.242000579833984,-27.364999771118164 26.243999481201172,-27.36400032043457 26.243999481201172,-27.36400032043457 C26.243999481201172,-27.36400032043457 26.2450008392334,-27.36400032043457 26.246000289916992,-27.363000869750977 C26.246000289916992,-27.363000869750977 26.249000549316406,-27.36199951171875 26.249000549316406,-27.36199951171875 C26.249000549316406,-27.36199951171875 26.249000549316406,-27.361000061035156 26.25,-27.361000061035156 C26.492000579833984,-27.240999221801758 26.711999893188477,-27.086999893188477 26.9060001373291,-26.9060001373291 C26.9060001373291,-26.905000686645508 26.9060001373291,-26.905000686645508 26.9060001373291,-26.905000686645508 C26.906999588012695,-26.90399932861328 26.908000946044922,-26.902999877929688 26.909000396728516,-26.902000427246094 C27.059999465942383,-26.760000228881836 27.195999145507812,-26.60099983215332 27.312999725341797,-26.424999237060547 C27.31399917602539,-26.424999237060547 27.31399917602539,-26.423999786376953 27.31399917602539,-26.423999786376953 C27.31399917602539,-26.423999786376953 27.31399917602539,-26.42300033569336 27.31399917602539,-26.42300033569336 C27.344999313354492,-26.378000259399414 27.37299919128418,-26.332000732421875 27.402000427246094,-26.284000396728516 C27.402000427246094,-26.284000396728516 37.926998138427734,-8.402000427246094 37.926998138427734,-8.402000427246094 C38.53900146484375,-7.361000061035156 38.402000427246094,-6.041999816894531 37.58700180053711,-5.14900016784668 C37.58700180053711,-5.14900016784668 1.7519999742507935,34.104000091552734 1.7519999742507935,34.104000091552734 C1.2309999465942383,34.67499923706055 0.492000013589859,35 -0.2809999883174896,35z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,38.30699920654297,35)"
                            >
                              <path
                                fill="rgb(86,252,126)"
                                fillOpacity={1}
                                d=" M25.023000717163086,-24.89699935913086 C25.023000717163086,-24.89699935913086 13.831999778747559,-29.77199935913086 13.831999778747559,-29.77199935913086 C13.831999778747559,-29.77199935913086 -0.09099999815225601,-32.24700164794922 -0.09099999815225601,-32.24700164794922 C-0.09099999815225601,-32.24700164794922 -14.088000297546387,-29.77199935913086 -14.088000297546387,-29.77199935913086 C-14.088000297546387,-29.77199935913086 -24.917999267578125,-25.04400062561035 -24.917999267578125,-25.04400062561035 C-24.917999267578125,-25.04400062561035 -35.55400085449219,-7.215000152587891 -35.55400085449219,-7.215000152587891 C-35.55400085449219,-7.215000152587891 -0.2809999883174896,32.24700164794922 -0.2809999883174896,32.24700164794922 C-0.2809999883174896,32.24700164794922 35.55400085449219,-7.00600004196167 35.55400085449219,-7.00600004196167 C35.55400085449219,-7.00600004196167 25.023000717163086,-24.89699935913086 25.023000717163086,-24.89699935913086z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,30.392000198364258,28.7549991607666)"
                            >
                              <path
                                fill="rgb(6,227,3)"
                                fillOpacity={1}
                                d=" M-8.263999938964844,-10.008000373840332 C-8.263999938964844,-10.008000373840332 -6.172999858856201,10.008000373840332 -6.172999858856201,10.008000373840332 C-6.172999858856201,10.008000373840332 8.263999938964844,-6.982999801635742 8.263999938964844,-6.982999801635742 C8.263999938964844,-6.982999801635742 -8.263999938964844,-10.008000373840332 -8.263999938964844,-10.008000373840332z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,64.11799621582031,19.048999786376953)"
                            >
                              <path
                                fill="rgb(5,169,2)"
                                fillOpacity={1}
                                d=" M9.743000030517578,8.944999694824219 C9.743000030517578,8.944999694824219 -0.7879999876022339,-8.944999694824219 -0.7879999876022339,-8.944999694824219 C-0.7879999876022339,-8.944999694824219 -9.743000030517578,-0.041999999433755875 -9.743000030517578,-0.041999999433755875 C-9.743000030517578,-0.041999999433755875 9.743000030517578,8.944999694824219 9.743000030517578,8.944999694824219z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,62.303001403808594,28.743000030517578)"
                            >
                              <path
                                fill="rgb(3,189,2)"
                                fillOpacity={1}
                                d=" M-11.557999610900879,9.736000061035156 C-11.557999610900879,9.736000061035156 11.557999610900879,-0.7490000128746033 11.557999610900879,-0.7490000128746033 C11.557999610900879,-0.7490000128746033 -7.928999900817871,-9.736000061035156 -7.928999900817871,-9.736000061035156 C-7.928999900817871,-9.736000061035156 -11.557999610900879,9.736000061035156 -11.557999610900879,9.736000061035156z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,46.43199920654297,28.757999420166016)"
                            >
                              <path
                                fill="rgb(1,228,1)"
                                fillOpacity={1}
                                d=" M-7.941999912261963,-6.822000026702881 C-7.941999912261963,-6.822000026702881 4.245999813079834,9.75100040435791 4.245999813079834,9.75100040435791 C4.245999813079834,9.75100040435791 4.313000202178955,9.720999717712402 4.313000202178955,9.720999717712402 C4.313000202178955,9.720999717712402 7.941999912261963,-9.75100040435791 7.941999912261963,-9.75100040435791 C7.941999912261963,-9.75100040435791 -7.941999912261963,-6.822000026702881 -7.941999912261963,-6.822000026702881z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,37.44900131225586,30.350000381469727)"
                            >
                              <path
                                fill="rgb(0,212,3)"
                                fillOpacity={1}
                                d=" M-13.229999542236328,8.413000106811523 C-13.229999542236328,8.413000106811523 13.229999542236328,8.15999984741211 13.229999542236328,8.15999984741211 C13.229999542236328,8.15999984741211 1.0410000085830688,-8.413000106811523 1.0410000085830688,-8.413000106811523 C1.0410000085830688,-8.413000106811523 -13.229999542236328,8.413000106811523 -13.229999542236328,8.413000106811523z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,13.486000061035156,28.83799934387207)"
                            >
                              <path
                                fill="rgb(8,252,2)"
                                fillOpacity={1}
                                d=" M-10.732999801635742,-1.0520000457763672 C-10.732999801635742,-1.0520000457763672 10.732999801635742,9.925000190734863 10.732999801635742,9.925000190734863 C10.732999801635742,9.925000190734863 8.807000160217285,-9.925000190734863 8.807000160217285,-9.925000190734863 C8.807000160217285,-9.925000190734863 -10.732999801635742,-1.0520000457763672 -10.732999801635742,-1.0520000457763672z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,37.481998443603516,52.862998962402344)"
                            >
                              <path
                                fill="rgb(8,252,2)"
                                fillOpacity={1}
                                d=" M13.196999549865723,-14.354000091552734 C13.196999549865723,-14.354000091552734 -13.262999534606934,-14.10099983215332 -13.262999534606934,-14.10099983215332 C-13.262999534606934,-14.10099983215332 0.5450000166893005,14.383000373840332 0.5450000166893005,14.383000373840332 C0.5450000166893005,14.383000373840332 13.196000099182129,-14.02299976348877 13.196000099182129,-14.02299976348877 C13.196000099182129,-14.02299976348877 13.262999534606934,-14.383000373840332 13.262999534606934,-14.383000373840332 C13.262999534606934,-14.383000373840332 13.196999549865723,-14.354000091552734 13.196999549865723,-14.354000091552734z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,55.944000244140625,47.62099838256836)"
                            >
                              <path
                                fill="rgb(1,153,2)"
                                fillOpacity={1}
                                d=" M-5.198999881744385,-9.142000198364258 C-5.198999881744385,-9.142000198364258 -5.265999794006348,-8.781000137329102 -5.265999794006348,-8.781000137329102 C-5.265999794006348,-8.781000137329102 -17.91699981689453,19.625999450683594 -17.91699981689453,19.625999450683594 C-17.91699981689453,19.625999450683594 17.91699981689453,-19.625999450683594 17.91699981689453,-19.625999450683594 C17.91699981689453,-19.625999450683594 -5.198999881744385,-9.142000198364258 -5.198999881744385,-9.142000198364258z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,20.388999938964844,47.51599884033203)"
                            >
                              <path
                                fill="rgb(1,226,0)"
                                fillOpacity={1}
                                d=" M-17.636999130249023,-19.729999542236328 C-17.636999130249023,-19.729999542236328 17.636999130249023,19.729999542236328 17.636999130249023,19.729999542236328 C17.636999130249023,19.729999542236328 3.8289999961853027,-8.753000259399414 3.8289999961853027,-8.753000259399414 C3.8289999961853027,-8.753000259399414 -17.636999130249023,-19.729999542236328 -17.636999130249023,-19.729999542236328z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,38.35900115966797,12.345000267028809)"
                            >
                              <path
                                fill="rgb(8,252,2)"
                                fillOpacity={1}
                                d=" M13.779000282287598,-7.117000102996826 C13.779000282287598,-7.117000102996826 -0.14399999380111694,-9.592000007629395 -0.14399999380111694,-9.592000007629395 C-0.14399999380111694,-9.592000007629395 -14.140999794006348,-7.117000102996826 -14.140999794006348,-7.117000102996826 C-14.140999794006348,-7.117000102996826 -24.97100067138672,-2.3889999389648438 -24.97100067138672,-2.3889999389648438 C-24.97100067138672,-2.3889999389648438 -19.09000015258789,3.5269999504089355 -19.09000015258789,3.5269999504089355 C-19.09000015258789,3.5269999504089355 -16.06599998474121,6.567999839782715 -16.06599998474121,6.567999839782715 C-16.06599998474121,6.567999839782715 -8.567999839782715,7.9670000076293945 -8.567999839782715,7.9670000076293945 C-8.567999839782715,7.9670000076293945 0.13199999928474426,9.592000007629395 0.13199999928474426,9.592000007629395 C0.13199999928474426,9.592000007629395 16.013999938964844,6.660999774932861 16.013999938964844,6.660999774932861 C16.013999938964844,6.660999774932861 24.97100067138672,-2.242000102996826 24.97100067138672,-2.242000102996826 C24.97100067138672,-2.242000102996826 13.779000282287598,-7.117000102996826 13.779000282287598,-7.117000102996826z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,12.52299976348877,18.871000289916992)"
                            >
                              <path
                                fill="rgb(86,252,126)"
                                fillOpacity={1}
                                d=" M6.747000217437744,-2.999000072479248 C6.747000217437744,-2.999000072479248 0.8659999966621399,-8.914999961853027 0.8659999966621399,-8.914999961853027 C0.8659999966621399,-8.914999961853027 -9.770000457763672,8.914999961853027 -9.770000457763672,8.914999961853027 C-9.770000457763672,8.914999961853027 9.770000457763672,0.041999999433755875 9.770000457763672,0.041999999433755875 C9.770000457763672,0.041999999433755875 6.747000217437744,-2.999000072479248 6.747000217437744,-2.999000072479248z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,25.80299949645996,6.790999889373779)"
                            >
                              <path
                                fill="rgb(86,252,126)"
                                fillOpacity={1}
                                d=" M-11.90999984741211,4.038000106811523 C-11.90999984741211,4.038000106811523 -1.437000036239624,-1.3650000095367432 -1.437000036239624,-1.3650000095367432 C-1.437000036239624,-1.3650000095367432 12.413000106811523,-4.038000106811523 12.413000106811523,-4.038000106811523 C12.413000106811523,-4.038000106811523 -1.5829999446868896,-1.562999963760376 -1.5829999446868896,-1.562999963760376 C-1.5829999446868896,-1.562999963760376 -12.413000106811523,3.1649999618530273 -12.413000106811523,3.1649999618530273 C-12.413000106811523,3.1649999618530273 -11.90999984741211,4.038000106811523 -11.90999984741211,4.038000106811523z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,22.658000946044922,28.836999893188477)"
                            >
                              <path
                                fill="rgb(86,252,126)"
                                fillOpacity={1}
                                d=" M-0.36500000953674316,-9.925000190734863 C-0.36500000953674316,-9.925000190734863 1.5609999895095825,9.925000190734863 1.5609999895095825,9.925000190734863 C1.5609999895095825,9.925000190734863 -1.5609999895095825,-9.788999557495117 -1.5609999895095825,-9.788999557495117 C-1.5609999895095825,-9.788999557495117 -0.36500000953674316,-9.925000190734863 -0.36500000953674316,-9.925000190734863z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,30.391000747680664,20.697999954223633)"
                            >
                              <path
                                fill="rgb(86,252,126)"
                                fillOpacity={1}
                                d=" M-8.097999572753906,-1.7860000133514404 C-8.097999572753906,-1.7860000133514404 8.097999572753906,1.2380000352859497 8.097999572753906,1.2380000352859497 C8.097999572753906,1.2380000352859497 7.635000228881836,1.7860000133514404 7.635000228881836,1.7860000133514404 C7.635000228881836,1.7860000133514404 -8.097999572753906,-1.7860000133514404 -8.097999572753906,-1.7860000133514404z"
                              />
                            </g>
                            <g
                              opacity={1}
                              transform="matrix(1,0,0,1,58.165000915527344,14.6899995803833)"
                            >
                              <path
                                fill="rgb(86,252,126)"
                                fillOpacity={1}
                                d=" M5.164999961853027,-4.586999893188477 C5.164999961853027,-4.586999893188477 -5.164999961853027,4.586999893188477 -5.164999961853027,4.586999893188477 C-5.164999961853027,4.586999893188477 -3.7899999618530273,4.315999984741211 -3.7899999618530273,4.315999984741211 C-3.7899999618530273,4.315999984741211 5.164999961853027,-4.586999893188477 5.164999961853027,-4.586999893188477z"
                              />
                            </g>
                          </g>
                          <g style={{ display: "none" }}>
                            <g>
                              <path />
                            </g>
                          </g>
                          <g style={{ display: "none" }}>
                            <g>
                              <path />
                            </g>
                          </g>
                          <g style={{ display: "none" }}>
                            <g>
                              <path />
                            </g>
                          </g>
                          <g style={{ display: "none" }}>
                            <g>
                              <path />
                            </g>
                          </g>
                          <g style={{ display: "none" }}>
                            <g>
                              <path />
                            </g>
                          </g>
                          <g style={{ display: "none" }}>
                            <g>
                              <path />
                            </g>
                          </g>
                        </g>
                      </svg>
                    </div>
                  </div>
                )}
                <div
                  className={cn(
                    "cover  svelte-vvbnu4",
                    box?.win && "gem",
                    box?.mine && "mine",
                    !box?.mine && !box?.win && "idle",
                    box?.id === loadingBoxId && "fetching"
                  )}
                />
              </button>
              {showWinModal && (
                <WinModal
                  current_multiplier={current_multiplier}
                  winMultiplier={winMultiplier}
                />
              )}
            </>
          );
        })}
      </div>
    </div>
  );
};

export default Boxes;
